<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ¾ å°ç‹—å¤–å–é¥­ç›†</title>
    <!-- Load Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for the Puppy Theme */
        :root {
            --primary-color: #42A5F5; /* Playful Blue (Dog Collar/Action) */
            --secondary-color: #FFA726; /* Warm Orange/Tan (Snacks/Highlight) */
            --bg-color: #FFFCF7; /* Soft Cream Background */
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
        }
        /* Card styles: More rounded corners and subtle border */
        .card {
            background-color: white;
            border-radius: 1.5rem; 
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            padding: 1.5rem;
            transition: transform 0.2s;
            border: 2px solid #EEE0C3; /* Light tan border */
        }
        .card:hover {
            box-shadow: 0 15px 25px -5px rgba(0, 0, 0, 0.15), 0 6px 10px -4px rgba(0, 0, 0, 0.08);
        }
        /* Primary Button: Pill shape and soft shadow */
        .btn-primary {
            background-color: var(--primary-color);
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 9999px; 
            font-weight: 700;
            transition: background-color 0.2s, transform 0.1s;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        .btn-primary:hover {
            background-color: #1E88E5; /* Darker Blue */
            transform: translateY(-1px);
        }
        /* Input fields */
        input[type="text"], input[type="number"], select {
            padding: 0.75rem;
            border: 1px solid #D1D5DB;
            border-radius: 0.75rem;
            width: 100%;
            transition: border-color 0.2s, box-shadow 0.2s;
            background-color: #FEFEFA; /* Slight off-white */
        }
        input:focus, select:focus {
            border-color: var(--secondary-color); /* Focus uses the warm orange color */
            box-shadow: 0 0 0 3px rgba(255, 167, 38, 0.4); 
            outline: none;
        }
        /* Override category color for theme consistency */
        .text-indigo-600 {
            color: var(--secondary-color) !important;
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-4xl mx-auto space-y-8">
        <h1 class="text-4xl font-extrabold text-gray-900 text-center mb-10">ğŸ¾ å°ç‹—å¤–å–é¥­ç›† ğŸ¶</h1>
        
        <!-- Section 1: Add New Entry -->
        <div class="card">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4 border-b pb-2">ğŸ¦´ è®°å½•æ–°çš„é›¶é£Ÿ</h2>
            <form id="add-takeout-form" class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
                <div class="md:col-span-1">
                    <label for="takeout-name" class="block text-sm font-medium text-gray-700 mb-1">é›¶é£Ÿåç§°</label>
                    <input type="text" id="takeout-name" placeholder="å¦‚: é¸¡è‚‰å¹²" required>
                </div>
                <div class="md:col-span-1">
                    <label for="takeout-price" class="block text-sm font-medium text-gray-700 mb-1">ä»·æ ¼ (å…ƒ)</label>
                    <input type="number" id="takeout-price" placeholder="å¦‚: 18.5" step="0.01" required>
                </div>
                <div class="md:col-span-1">
                    <label for="takeout-category" class="block text-sm font-medium text-gray-700 mb-1">ç§ç±»/å£å‘³</label>
                    <input type="text" id="takeout-category" placeholder="å¦‚: é¸¡è‚‰, éª¨å¤´, é¢é£Ÿ" required>
                </div>
                <div class="md:col-span-1">
                    <button type="submit" class="btn-primary w-full">ğŸ’¾ å­˜å…¥é¥­ç›†</button>
                </div>
            </form>
        </div>

        <!-- Section 2: Filters and Random Pick -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Filtering Controls -->
            <div class="card lg:col-span-2 space-y-4">
                <h2 class="text-2xl font-semibold text-gray-800 border-b pb-2">ğŸ” ç­›é€‰æƒ³åƒçš„</h2>
                <div class="flex flex-col sm:flex-row gap-4">
                    <div class="flex-1">
                        <label for="price-filter" class="block text-sm font-medium text-gray-700 mb-1">ä»·æ ¼ç­›é€‰ (æ¨è 20 å…ƒå·¦å³)</label>
                        <select id="price-filter">
                            <option value="all">ä¸é™ä»·æ ¼</option>
                            <option value="around20">â‰ˆ 20 å…ƒ (15-25å…ƒ)</option>
                            <option value="cheap">â‰¤ 15 å…ƒ (ä¾¿å®œ)</option>
                            <option value="expensive">â‰¥ 25 å…ƒ (ç¨è´µ)</option>
                        </select>
                    </div>
                    <div class="flex-1">
                        <label for="category-filter" class="block text-sm font-medium text-gray-700 mb-1">ç§ç±»ç­›é€‰ (è¾“å…¥ç±»åˆ«)</label>
                        <select id="category-filter">
                            <option value="all">æ‰€æœ‰ç§ç±»</option>
                        </select>
                    </div>
                </div>
                <p id="filter-status" class="text-sm text-gray-500 pt-2">å…±æ‰¾åˆ° <span id="item-count" class="font-bold text-gray-700">0</span> ç§é›¶é£Ÿã€‚</p>
            </div>

            <!-- Random Selection -->
            <div class="card lg:col-span-1 flex flex-col justify-between items-center text-center p-6 space-y-4 bg-amber-50">
                <h2 class="text-2xl font-semibold text-gray-800 border-b pb-2 w-full">ä»Šå¤©åƒå“ªä¸ªï¼Ÿ</h2>
                <!-- Button uses the secondary color for the theme -->
                <button id="random-pick-btn" class="btn-primary w-full bg-[#FFA726] hover:bg-[#FF8A00]">ğŸ• éšæœºæŠ½é€‰</button>
                <div id="random-result" class="text-xl font-bold text-gray-800 min-h-[3rem] w-full p-2 border-2 border-dashed border-amber-200 rounded-lg flex items-center justify-center bg-amber-50">
                    ç‚¹å‡»æŒ‰é’®æŠ½å–...
                </div>
            </div>
        </div>

        <!-- Section 3: Takeout Log Display -->
        <div class="card">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4 border-b pb-2">ğŸ“‹ å†å²é›¶é£Ÿè®°å½•</h2>
            <div id="takeout-list" class="space-y-3">
                <!-- Records will be injected here -->
                <p class="text-gray-500 text-center py-4" id="loading-indicator">
                    æ­£åœ¨åŠ è½½é›¶é£Ÿæ•°æ®...
                </p>
                <p class="text-gray-500 text-center py-4 hidden" id="no-data-message">
                    æ‚¨è¿˜æ²¡æœ‰è®°å½•ä»»ä½•é›¶é£Ÿï¼Œå¿«å»æ·»åŠ ä¸€æ¡å§ï¼
                </p>
            </div>
        </div>

        <!-- Debug/User ID -->
        <div class="text-xs text-gray-400 text-center pt-4">
            <p>åº”ç”¨ ID: <span id="app-id-display"></span></p>
            <p>ç”¨æˆ· ID (ç”¨äºæ•°æ®éš”ç¦»): <span id="user-id-display"></span></p>
        </div>

    </div>

    <!-- Firebase SDKs and Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        // setLogLevel is not imported as it's not strictly necessary for deployment

        // --- GLOBAL VARIABLES (Canvas Environment Placeholders) ---
        // NOTE: When deploying to Vercel/GitHub, you MUST manually replace __app_id, __firebase_config,
        // and __initial_auth_token with actual values or environment variables.
        // For local testing, default values are used.
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-takeout-app';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Display IDs for debugging/sharing
        document.getElementById('app-id-display').textContent = appId;

        // --- FIREBASE INITIALIZATION ---
        let app, db, auth, userId = null;
        let allTakeouts = []; 
        let filteredTakeouts = []; 

        // DOM Elements
        const addForm = document.getElementById('add-takeout-form');
        const listContainer = document.getElementById('takeout-list');
        const priceFilter = document.getElementById('price-filter');
        const categoryFilter = document.getElementById('category-filter');
        const randomPickBtn = document.getElementById('random-pick-btn');
        const randomResult = document.getElementById('random-result');
        const itemCountDisplay = document.getElementById('item-count');
        const loadingIndicator = document.getElementById('loading-indicator');
        const noDataMessage = document.getElementById('no-data-message');


        /**
         * Converts a Firestore timestamp object to a readable date string.
         * @param {Object} timestamp - Firestore Timestamp object.
         * @returns {string} Formatted date string.
         */
        const formatDate = (timestamp) => {
            if (!timestamp || !timestamp.toDate) return 'æœªçŸ¥æ—¥æœŸ';
            const date = timestamp.toDate();
            return date.toLocaleDateString('zh-CN', {
                year: 'numeric',
                month: 'numeric',
                day: 'numeric'
            });
        };

        /**
         * Renders the list of takeout entries to the UI.
         * @param {Array<Object>} items - The list of items to render.
         */
        const renderList = (items) => {
            listContainer.innerHTML = ''; // Clear previous items
            
            if (items.length === 0) {
                listContainer.appendChild(noDataMessage);
                noDataMessage.textContent = 'æ²¡æœ‰æ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„è®°å½•ã€‚';
                noDataMessage.classList.remove('hidden');
                itemCountDisplay.textContent = '0';
                return;
            }

            // Hide message if there are items
            noDataMessage.classList.add('hidden');

            items.forEach(item => {
                const itemEl = document.createElement('div');
                // Use hover:bg-amber-50 for a thematic hover color
                itemEl.className = 'flex flex-col sm:flex-row justify-between items-start sm:items-center p-4 bg-white hover:bg-amber-50 rounded-lg transition-colors border border-gray-200';
                
                // Name and Category
                const titleBlock = document.createElement('div');
                titleBlock.className = 'mb-2 sm:mb-0';
                titleBlock.innerHTML = `
                    <p class="text-lg font-semibold text-gray-800">${item.name}</p>
                    <p class="text-sm text-gray-500">ç§ç±»: <span class="text-indigo-600 font-medium">${item.category}</span></p>
                `;

                // Price and Date
                const infoBlock = document.createElement('div');
                infoBlock.className = 'text-right';
                infoBlock.innerHTML = `
                    <p class="text-xl font-bold text-secondary-color">Â¥${item.price.toFixed(2)}</p>
                    <p class="text-xs text-gray-400 mt-1">è®°å½•äº: ${formatDate(item.timestamp)}</p>
                `;

                itemEl.appendChild(titleBlock);
                itemEl.appendChild(infoBlock);
                listContainer.appendChild(itemEl);
            });
            itemCountDisplay.textContent = items.length;
        };
        
        /**
         * Filters the main list based on current UI selections.
         */
        const applyFilters = () => {
            if (!allTakeouts.length) {
                filteredTakeouts = [];
                renderList(filteredTakeouts);
                return;
            }

            const priceVal = priceFilter.value;
            const categoryVal = categoryFilter.value;

            filteredTakeouts = allTakeouts.filter(item => {
                // Price Filter Logic
                let priceMatch = true;
                const price = parseFloat(item.price);
                if (priceVal === 'around20') {
                    priceMatch = (price >= 15 && price <= 25);
                } else if (priceVal === 'cheap') {
                    priceMatch = (price <= 15);
                } else if (priceVal === 'expensive') {
                    priceMatch = (price >= 25);
                }
                
                // Category Filter Logic
                let categoryMatch = true;
                if (categoryVal !== 'all') {
                    // Case-insensitive, partial match 
                    categoryMatch = item.category && item.category.toLowerCase().includes(categoryVal.toLowerCase());
                }

                return priceMatch && categoryMatch;
            });

            renderList(filteredTakeouts);
        };
        
        /**
         * Populates the category filter dropdown with unique categories.
         */
        const populateCategoryFilter = () => {
            const categories = new Set();
            allTakeouts.forEach(item => {
                // Handle categories that might be comma-separated by user
                if (item.category) {
                    item.category.split(',').forEach(cat => {
                        const trimmedCat = cat.trim();
                        if (trimmedCat) categories.add(trimmedCat);
                    });
                }
            });

            // Save current selection to restore it later
            const currentCategory = categoryFilter.value;
            
            categoryFilter.innerHTML = '<option value="all">æ‰€æœ‰ç§ç±»</option>';
            [...categories].sort().forEach(cat => {
                const option = document.createElement('option');
                option.value = cat;
                option.textContent = cat;
                if (cat === currentCategory) {
                    option.selected = true;
                }
                categoryFilter.appendChild(option);
            });
            
            // Re-apply filters after population
            applyFilters();
        };

        // --- FIREBASE DATA LISTENERS ---
        const setupFirestoreListener = () => {
            if (!db || !userId) return;

            // Data storage path: /artifacts/{appId}/users/{userId}/takeout_log
            const takeoutRef = collection(db, `/artifacts/${appId}/users/${userId}/takeout_log`);
            const q = query(takeoutRef); 

            // Real-time listener
            onSnapshot(q, (snapshot) => {
                loadingIndicator.classList.add('hidden');
                const tempTakeouts = [];
                snapshot.forEach(doc => {
                    tempTakeouts.push({ id: doc.id, ...doc.data() });
                });

                // Sort by timestamp in descending order (newest first) in client
                tempTakeouts.sort((a, b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));

                allTakeouts = tempTakeouts;
                populateCategoryFilter(); // Populates categories and applies filters
            }, (error) => {
                console.error("Error listening to Firestore: ", error);
                loadingIndicator.textContent = 'æ•°æ®åŠ è½½å¤±è´¥ã€‚è¯·æ£€æŸ¥æ§åˆ¶å°é”™è¯¯ã€‚';
            });
        };

        // --- AUTHENTICATION AND INITIALIZATION ---
        const initializeAppAndAuth = async () => {
            if (Object.keys(firebaseConfig).length === 0) {
                 loadingIndicator.textContent = 'é”™è¯¯: Firebase é…ç½®æœªæä¾›ã€‚';
                 console.error("Firebase config is missing.");
                 return;
            }
            
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Sign in with custom token if available, otherwise sign in anonymously
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
                
                // Wait for auth state change to get the userId
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        document.getElementById('user-id-display').textContent = userId;
                        setupFirestoreListener(); // Start listening to data
                    } else {
                        console.log("No user signed in.");
                        loadingIndicator.textContent = 'ç”¨æˆ·æœªè®¤è¯ã€‚';
                    }
                });

            } catch (error) {
                console.error("Firebase initialization or authentication failed:", error);
                loadingIndicator.textContent = `è®¤è¯å¤±è´¥: ${error.message}`;
            }
        };

        // --- EVENT HANDLERS ---
        
        // 1. Add Entry Handler
        addForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (!userId || !db) {
                console.error("Database or User ID is not ready.");
                return;
            }

            const nameInput = document.getElementById('takeout-name');
            const priceInput = document.getElementById('takeout-price');
            const categoryInput = document.getElementById('takeout-category');

            const newEntry = {
                name: nameInput.value.trim(),
                price: parseFloat(priceInput.value),
                category: categoryInput.value.trim(),
                timestamp: new Date(), 
            };

            const takeoutRef = collection(db, `/artifacts/${appId}/users/${userId}/takeout_log`);
            
            try {
                await addDoc(takeoutRef, newEntry);
                console.log("Document successfully written!");
                // Clear the form fields after successful submission
                nameInput.value = '';
                priceInput.value = '';
                categoryInput.value = '';
            } catch (error) {
                console.error("Error adding document: ", error);
            }
        });

        // 2. Filter Handlers
        priceFilter.addEventListener('change', applyFilters);
        categoryFilter.addEventListener('change', applyFilters);

        // 3. Random Selection Handler
        randomPickBtn.addEventListener('click', () => {
            if (filteredTakeouts.length === 0) {
                randomResult.textContent = 'ğŸ˜­ åˆ—è¡¨ä¸­æ²¡æœ‰é›¶é£Ÿå¯ä¾›é€‰æ‹©ï¼';
                randomResult.classList.remove('bg-amber-50'); 
                randomResult.classList.add('bg-red-100');
                return;
            }
            
            const randomIndex = Math.floor(Math.random() * filteredTakeouts.length);
            const selectedItem = filteredTakeouts[randomIndex];

            randomResult.classList.remove('bg-red-100');
            randomResult.classList.add('bg-amber-50');

            randomResult.textContent = 'æŠ½å–ä¸­...';
            randomPickBtn.disabled = true;

            setTimeout(() => {
                randomResult.innerHTML = `
                    ğŸ‰ æ­å–œ! ä»Šå¤©åƒ: <span class="text-primary-color">${selectedItem.name}</span>
                    <span class="text-sm font-normal text-gray-600">(Â¥${selectedItem.price.toFixed(2)}, ${selectedItem.category})</span>
                `;
                randomPickBtn.disabled = false;
            }, 500);
        });


        // --- START THE APP ---
        window.onload = initializeAppAndAuth;

    </script>
</body>
</html>
